<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 éŸŒé«”ç‡’éŒ„å™¨</title>
</head>
<body>
  <h1>ESP32 éŸŒé«”ç‡’éŒ„å·¥å…·</h1>
  <button id="flashButton" disabled>é–‹å§‹ç‡’éŒ„</button>
  <pre id="log" style="background: #111; color: #0f0; padding: 10px; white-space: pre-wrap;"></pre>

  <script>
    const flashButton = document.getElementById("flashButton");
    const log = (msg) => {
      const el = document.getElementById("log");
      if (el) el.textContent += msg + "\n";
    };

    let environmentOK = true;

    window.addEventListener("load", () => {
      // 1. æª¢æŸ¥ file://
      if (location.protocol === "file:") {
        log("âš ï¸ æœ¬é æ˜¯ä»¥ file:// é–‹å•Ÿï¼Œéƒ¨åˆ†ç€è¦½å™¨å¯èƒ½ç¦æ­¢è¼‰å…¥æ¨¡çµ„æˆ– bin æª”ã€‚å»ºè­°ä½¿ç”¨æœ¬åœ° HTTP ä¼ºæœå™¨é–‹å•Ÿæ­¤é é¢ã€‚");
        environmentOK = false;
      }

      // 2. æª¢æŸ¥ HTTPS æˆ– localhost
      if (location.protocol !== "https:" && location.hostname !== "localhost") {
        log("âš ï¸ æœ¬é ä¸æ˜¯åœ¨ HTTPS æˆ– localhost ç¶²å€ä¸‹é–‹å•Ÿï¼ŒWeb Serial API å¯èƒ½æœƒè¢«å°é–ã€‚å»ºè­°ä½¿ç”¨ Chrome ä¸¦é€é HTTPS æˆ– localhost é–‹å•Ÿã€‚");
        environmentOK = false;
      }

      // 3. æª¢æŸ¥ Web Serial æ”¯æ´
      if (!("serial" in navigator)) {
        log("âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Serial APIã€‚è«‹ä½¿ç”¨æœ€æ–°ç‰ˆçš„ Google Chrome æˆ– Microsoft Edgeã€‚");
        environmentOK = false;
      }

      // âœ… å¦‚æœç’°å¢ƒ OKï¼Œå•Ÿç”¨æŒ‰éˆ•
      if (environmentOK) {
        flashButton.disabled = false;
        log("âœ… ç’°å¢ƒæª¢æŸ¥é€šéï¼Œå¯ä»¥é–‹å§‹ç‡’éŒ„ï¼");
      } else {
        log("ğŸš« ç„¡æ³•å•Ÿç”¨ç‡’éŒ„ï¼Œè«‹ä¿®æ­£ä¸Šæ–¹ç’°å¢ƒå•é¡Œ");
      }
    });
  </script>

  <script type="module">
    // æ›´æ–°å¼•ç”¨çš„ ESPloader åº«æ–‡ä»¶çš„è·¯å¾‘
    import { ESPLoader } from "/esptool-js@0.5.4/package/bundle.js";  <!-- æ›´æ”¹ç‚ºæœ¬åœ°çš„ bundle.js è·¯å¾‘ -->

    flashButton.addEventListener("click", async () => {
      try {
        log("ğŸ”Œ è«‹é¸æ“‡ ESP32 è£ç½®...");
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        const loader = new ESPLoader(port, 115200, log);
        await loader.initialize();
        const chip = await loader.chipName();
        log(`âœ… å·²é€£æ¥æ™¶ç‰‡ï¼š${chip}`);

        const files = [
          { name: "Bootloader", url: "R2MS_Lite_RelayBoard_QC_v20250419a.ino.bootloader.bin", address: 0x1000 },
          { name: "Partitions", url: "R2MS_Lite_RelayBoard_QC_v20250419a.ino.partitions.bin", address: 0x8000 },
          { name: "Application", url: "R2MS_Lite_RelayBoard_QC_v20250419a.ino.bin", address: 0x10000 },
        ];

        for (const file of files) {
          log(`ğŸ“¥ è¼‰å…¥ ${file.name} (${file.url})...`);
          const response = await fetch(file.url);
          if (!response.ok) {
            throw new Error(`ç„¡æ³•è¼‰å…¥æª”æ¡ˆï¼š${file.url}ï¼ˆHTTP ${response.status}ï¼‰`);
          }
          const data = new Uint8Array(await response.arrayBuffer());

          log(`âš¡ æ­£åœ¨ç‡’éŒ„ ${file.name} åˆ°ä½å€ 0x${file.address.toString(16)}...`);
          await loader.flashData(data, file.address);
          log(`âœ… ${file.name} ç‡’éŒ„å®Œæˆ`);
        }

        log("ğŸ‰ éŸŒé«”ç‡’éŒ„å®Œæˆï¼");
        await loader.hardReset();
        log("ğŸ” è£ç½®å·²é‡æ–°å•Ÿå‹•");

      } catch (err) {
        log("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + (err.message || err.toString()));

        if (err.message?.includes("The device is not eligible")) {
          log("ğŸ‘‰ æç¤ºï¼šè«‹ç¢ºèªé–‹ç™¼æ¿é€²å…¥ Boot æ¨¡å¼ï¼Œå¿…è¦æ™‚æŒ‰ä½ BOOT éµå†æ’å…¥ USB");
        } else if (err.message?.includes("NetworkError") || err.message?.includes("Failed to fetch")) {
          log("ğŸ‘‰ æç¤ºï¼šè«‹ç¢ºèª bin æª”æ¡ˆæœ‰æ”¾åœ¨å’Œæœ¬ HTML åŒä¸€è³‡æ–™å¤¾");
        } else if (err.message?.includes("Access denied")) {
          log("ğŸ‘‰ æç¤ºï¼šè«‹é‡æ–°æ’æ‹” USB ä¸¦ç¢ºèªç€è¦½å™¨å…è¨±å­˜å–åºåˆ—åŸ ");
        }

        console.error(err);
      }
    });
  </script>
</body>
</html>
